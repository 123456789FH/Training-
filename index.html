<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>اختبار تطبيقي تفاعلي | رياضيات</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#0ea5a4;
      --bg2:#7c3aed;
      --card:#ffffff;
      --ink:#0f172a;
      --muted:#64748b;
      --line:#e2e8f0;
      --good:#16a34a;
      --bad:#dc2626;
      --chip:#f1f5f9;
      --shadow: 0 18px 40px rgba(2,6,23,.12);
      --radius: 22px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:"Cairo", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      color:var(--ink);
      background: radial-gradient(1200px 700px at 15% 10%, rgba(255,255,255,.35), transparent 60%),
                  linear-gradient(135deg, var(--bg1), var(--bg2));
      min-height:100vh;
      padding:24px;
    }
    .wrap{max-width:980px;margin:0 auto}
    .topbar{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      margin-bottom:14px;
    }
    .brand{display:flex;align-items:center;gap:12px;color:#fff}
    .brand .logo{
      width:44px;height:44px;border-radius:14px;
      background: rgba(255,255,255,.18);
      display:grid;place-items:center;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.25);
      flex:0 0 auto;
    }
    .brand img{width:100%;height:100%;object-fit:contain;display:block}
    .brand .txt{line-height:1.1}
    .brand .txt b{display:block;font-size:18px}
    .brand .txt span{font-size:13px;opacity:.9}

    .card{
      background:var(--card);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      border:1px solid rgba(15,23,42,.06);
      overflow:hidden;
    }
    .cardHead{
      padding:16px 18px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background: linear-gradient(180deg, rgba(241,245,249,.9), rgba(255,255,255,.9));
    }
    .title{display:flex;flex-direction:column;gap:4px}
    .title h1{margin:0;font-size:18px}
    .title p{margin:0;color:var(--muted);font-size:13px}

    .pillRow{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:flex-end}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      background:var(--chip);
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius:999px;
      font-size:13px;color:var(--ink);
      white-space:nowrap;
    }
    .pill b{font-weight:800}

    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-size:12px;
      font-weight:900;
      color:var(--ink);
    }
    .chip.skill{
      background: rgba(124,58,237,.06);
      border-color: rgba(124,58,237,.22);
      color:#4c1d95;
    }

    .btn{
      appearance:none;border:0;cursor:pointer;
      padding:10px 12px;border-radius:12px;
      font-weight:800;font-size:13px;
      background:var(--ink);color:#fff;
      transition:transform .08s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.secondary{background:#fff;color:var(--ink);border:1px solid var(--line)}
    .btn.ghost{background:transparent;color:var(--ink);border:1px dashed var(--line)}

    .content{padding:18px}
    .grid2{display:grid;grid-template-columns: 1.2fr .8fr; gap:14px}
    @media (max-width: 860px){.grid2{grid-template-columns:1fr}}

    .panel{
      border:1px solid var(--line);
      border-radius:18px;
      padding:14px;
      background: rgba(248,250,252,.8);
    }
    .panel h2{margin:0 0 10px 0;font-size:15px}
    .field{display:flex;flex-direction:column;gap:6px;margin-bottom:10px}
    label{font-size:13px;color:var(--muted)}
    input[type="text"], input[type="number"]{
      padding:10px 12px;border-radius:12px;border:1px solid var(--line);
      font-family:inherit;font-size:14px;outline:none;background:#fff;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .toggle{
      display:inline-flex;align-items:center;gap:10px;
      background:#fff;border:1px solid var(--line);
      padding:10px 12px;border-radius:14px;user-select:none;
    }
    .toggle input{transform:scale(1.15)}
    .help{font-size:13px;color:var(--muted);margin:0}

    .progress{
      height:10px;background:rgba(15,23,42,.08);
      border-radius:999px;overflow:hidden;
      border:1px solid rgba(15,23,42,.08);
      margin-top:10px;
    }
    .bar{height:100%;width:0%;background:linear-gradient(90deg, var(--bg1), var(--bg2));}

    .qHead{display:flex;align-items:flex-start;justify-content:space-between;gap:12px;margin-bottom:8px}
    .qNum{
      display:inline-flex;align-items:center;gap:8px;
      font-weight:900;
      background: rgba(124,58,237,.10);
      color:#4c1d95;
      border:1px solid rgba(124,58,237,.18);
      padding:8px 10px;border-radius:14px;flex:0 0 auto;
    }
    .qText{margin:0;font-size:16px;line-height:1.8;font-weight:800}
    .subRow{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin:10px 0 12px 0}

    .media{
      margin:10px 0 14px 0;
      border:1px solid var(--line);
      border-radius:16px;
      background:#fff;
      padding:12px;
      overflow:auto;
    }

    .choices{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    @media (max-width:650px){.choices{grid-template-columns:1fr}}
    .choice{
      border:1px solid var(--line);
      background:#fff;border-radius:16px;
      padding:12px 12px;cursor:pointer;
      display:flex;gap:10px;align-items:flex-start;
      transition:transform .06s ease, border-color .12s ease, box-shadow .12s ease;
    }
    .choice:hover{transform:translateY(-1px)}
    .choice .key{
      width:34px;height:34px;border-radius:12px;
      background:rgba(14,165,164,.12);
      border:1px solid rgba(14,165,164,.22);
      display:grid;place-items:center;
      font-weight:900;color:#0f766e;flex:0 0 auto;
    }
    .choice .txt{font-weight:800;line-height:1.7}
    .choice.selected{
      border-color: rgba(124,58,237,.45);
      box-shadow: 0 10px 24px rgba(124,58,237,.12);
      background: linear-gradient(180deg, rgba(124,58,237,.06), #fff);
    }
    .choice.correct{border-color: rgba(22,163,74,.55);background: linear-gradient(180deg, rgba(22,163,74,.08), #fff)}
    .choice.wrong{border-color: rgba(220,38,38,.55);background: linear-gradient(180deg, rgba(220,38,38,.08), #fff)}

    .feedback{
      margin-top:12px;
      padding:12px 12px;border-radius:16px;
      border:1px solid var(--line);
      background: rgba(241,245,249,.8);
      display:none;
    }
    .feedback.good{border-color: rgba(22,163,74,.35); background: rgba(22,163,74,.08)}
    .feedback.bad{border-color: rgba(220,38,38,.35); background: rgba(220,38,38,.08)}
    .feedback h3{margin:0 0 6px 0;font-size:14px}
    .feedback p{margin:0;color:var(--ink);font-size:13px;line-height:1.9}
    .feedback ul{margin:8px 0 0 0; padding-inline-start:18px}
    .feedback li{margin:4px 0; font-size:13px; line-height:1.9}
    .note{
      margin-top:10px;
      padding:10px 12px;border-radius:14px;
      border:1px dashed rgba(15,23,42,.20);
      background: rgba(255,255,255,.75);
      font-size:13px;color:var(--ink);
    }

    .nav{
      display:flex;align-items:center;justify-content:space-between;
      gap:10px;flex-wrap:wrap;margin-top:14px;
      border-top:1px solid var(--line);
      padding-top:14px;
    }
    .nav .left, .nav .right{display:flex;gap:10px;flex-wrap:wrap}
    .mini{font-size:12px;color:var(--muted)}

    .resultBox{display:grid;grid-template-columns: 1fr 1fr; gap:12px}
    @media (max-width:860px){.resultBox{grid-template-columns:1fr}}
    .stat{
      border:1px solid var(--line);
      background:#fff;border-radius:18px;
      padding:14px;
    }
    .stat b{font-size:22px}
    .stat p{margin:6px 0 0 0;color:var(--muted)}
    .skillsNeed{
      margin-top:14px;
      border:1px solid var(--line);
      background:#fff;border-radius:18px;
      padding:14px;
    }
    .skillsNeed h3{margin:0 0 8px 0;font-size:15px}
    .skillsNeed .chips{display:flex;flex-wrap:wrap;gap:8px}

    .review{
      margin-top:12px;
      border:1px solid var(--line);
      background:#fff;border-radius:18px;
      overflow:hidden;
    }
    .review .rHead{
      padding:12px 14px;border-bottom:1px solid var(--line);
      background: rgba(241,245,249,.8);
      font-weight:900;
    }
    .review .rItem{padding:12px 14px;border-bottom:1px solid var(--line)}
    .review .rItem:last-child{border-bottom:0}
    .tag{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      font-size:12px;font-weight:900;
      border:1px solid var(--line);
      background:var(--chip);
      margin-inline-start:8px;
    }
    .tag.good{background: rgba(22,163,74,.10); border-color: rgba(22,163,74,.25); color:#14532d}
    .tag.bad{background: rgba(220,38,38,.10); border-color: rgba(220,38,38,.25); color:#7f1d1d}
    .rQ{margin:0 0 6px 0;font-weight:900}
    .rMeta{margin:0;color:var(--muted);font-size:13px;line-height:1.9}
    .rSteps{margin:6px 0 0 0; padding-inline-start:18px}
    .rSteps li{margin:4px 0; font-size:13px; line-height:1.9}

    footer{
      margin-top:14px;
      color: rgba(255,255,255,.92);
      text-align:center;
      font-size:13px;
    }

    @media print{
      body{background:#fff !important; padding:0}
      .topbar, footer{display:none !important}
      .btn, .pillRow, .toggle, .nav{display:none !important}
      .card{box-shadow:none;border:0}
      .content{padding:10px}
      .feedback{display:block !important}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo" title="الشعار (اختياري)">
          <img src="logo.png" alt="Logo" onerror="this.style.display='none'; this.parentElement.textContent='∑';" />
        </div>
        <div class="txt">
          <b>اختبار تطبيقي تفاعلي</b>
          <span>رياضيات | اختيار من متعدد (١٥ سؤال)</span>
        </div>
      </div>
      <div class="pillRow" id="statusPills" style="display:none">
        <span class="pill">الطالب: <b id="pillName">—</b></span>
        <span class="pill">التقدّم: <b id="pillProg">٠/٠</b></span>
        <span class="pill" id="pillTimerWrap" style="display:none">الوقت: <b id="pillTimer">—</b></span>
      </div>
    </div>

    <div class="card" id="app"></div>

    <footer>أ/فاطمة هزازي - ملتقى معلمي ومعلمات الرياضيات/الملتقى التفاعلي</footer>
  </div>

  <script>
    const arabicMap = {'0':'٠','1':'١','2':'٢','3':'٣','4':'٤','5':'٥','6':'٦','7':'٧','8':'٨','9':'٩'};
    const toArDigits = (v) => String(v).replace(/[0-9]/g, d => arabicMap[d]);
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));
    const uniq = (arr) => Array.from(new Set(arr));

    const PLACEHOLDER_IMG = "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";

    function initFallbackImages(root=document){
      const imgs = root.querySelectorAll('img[data-fallback]');
      imgs.forEach(img=>{
        if(img.dataset.inited) return;
        img.dataset.inited = "1";

        const candidates = (img.dataset.fallback || "")
          .split(",")
          .map(s=>s.trim())
          .filter(Boolean);

        let idx = 0;
        const tryLoad = () => {
          if(idx >= candidates.length){
            const msg = img.dataset.errmsg || "لم يتم العثور على الصورة.";
            const p = document.createElement("p");
            p.className = "help";
            p.style.textAlign = "center";
            p.textContent = msg;
            img.replaceWith(p);
            return;
          }
          img.src = candidates[idx++];
        };

        img.onerror = tryLoad;
        tryLoad();
      });
    }

    function mediaQ5(){
      return `
        <div class="media" aria-label="نمط المثلثات">
          <img
            src="${PLACEHOLDER_IMG}"
            data-fallback="q5.png,q5_new.png,assets/q5.png,images/q5.png"
            data-errmsg="لم يتم العثور على صورة سؤال ٥. ضعها باسم q5.png بجانب ملف الاختبار."
            alt="نمط مثلثات بارتفاعات ٥ سم، ٨ سم، ١٢ سم، ١٧ سم"
            loading="lazy"
            style="max-width:100%;height:auto;display:block;margin:auto;border-radius:14px"
          />
        </div>
      `;
    }

    function mediaQ8(){
      return `
        <div class="media" aria-label="أشكال هندسية">
          <svg viewBox="0 0 640 150" width="640" height="150" style="max-width:100%;height:auto;display:block;margin:auto">
            <defs>
              <style>
                .s{fill:rgba(14,165,164,.12);stroke:#0f172a;stroke-width:4}
                .t{font: 700 14px Cairo, sans-serif; fill:#0f172a}
              </style>
            </defs>
            <g transform="translate(35,25)">
              <rect class="s" x="0" y="25" width="70" height="70" rx="8"/>
              <polygon class="s" points="70,25 95,10 95,80 70,95"/>
              <polygon class="s" points="0,25 25,10 95,10 70,25"/>
              <text class="t" x="30" y="120">مكعب</text>
            </g>
            <g transform="translate(200,25)">
              <ellipse class="s" cx="45" cy="20" rx="35" ry="12"/>
              <rect class="s" x="10" y="20" width="70" height="70" rx="10"/>
              <ellipse class="s" cx="45" cy="90" rx="35" ry="12"/>
              <text class="t" x="22" y="120">أسطوانة</text>
            </g>
            <g transform="translate(365,20)">
              <polygon class="s" points="45,10 10,95 80,95"/>
              <ellipse class="s" cx="45" cy="95" rx="35" ry="10"/>
              <text class="t" x="25" y="125">مخروط</text>
            </g>
            <g transform="translate(520,28)">
              <polygon class="s" points="10,25 90,10 90,95 10,95"/>
              <text class="t" x="18" y="125">شكل مستوٍ</text>
            </g>
          </svg>
        </div>
      `;
    }

    function mediaQ9(){
      return `
        <div class="media" aria-label="شبكة مربعات">
          <div style="display:flex;justify-content:center">
            <div style="
              display:grid;
              grid-template-columns: repeat(3, 34px);
              grid-template-rows: repeat(2, 34px);
              gap:0;
              border:3px solid #0f172a;
              border-radius:10px;
              overflow:hidden;
            ">
              ${Array.from({length:6}).map(() => `
                <div style="width:34px;height:34px;border:1px solid #0f172a;background:rgba(124,58,237,.06)"></div>
              `).join('')}
            </div>
          </div>
          <p class="help" style="margin-top:10px;text-align:center">عدّ المربعات لإيجاد المساحة بوحدات مربعة.</p>
        </div>
      `;
    }

    function mediaQ10(){
      return `
        <div class="media" aria-label="مسطرة وخيط">
          <img
            src="${PLACEHOLDER_IMG}"
            data-fallback="q10.png,q10_new.png,assets/q10.png,images/q10.png"
            data-errmsg="لم يتم العثور على صورة سؤال ١٠. ضعها باسم q10.png بجانب ملف الاختبار."
            alt="خيط فوق مسطرة للتقدير"
            loading="lazy"
            style="max-width:100%;height:auto;display:block;margin:auto;border-radius:14px"
          />
          <p class="help" style="margin-top:8px;text-align:center">قدّر طول الخيط إذا شُدّ ليصبح مستقيمًا.</p>
        </div>
      `;
    }

    function mediaQ12(){
      return `
        <div class="media" aria-label="ساعة">
          <svg viewBox="0 0 260 260" width="260" height="260" style="max-width:100%;height:auto;display:block;margin:auto">
            <defs>
              <style>
                .c{fill:#fff;stroke:#0f172a;stroke-width:6}
                .t{font: 800 16px Cairo, sans-serif; fill:#0f172a}
                .tick{stroke:#0f172a;stroke-width:3}
                .min{stroke:#0f172a;stroke-width:6;stroke-linecap:round}
                .hr{stroke:#0f172a;stroke-width:8;stroke-linecap:round}
              </style>
            </defs>

            <circle class="c" cx="130" cy="130" r="110"></circle>

            ${Array.from({length:12}).map((_,i)=>{
              const ang = (Math.PI*2)*(i/12) - Math.PI/2;
              const x1 = 130 + Math.cos(ang)*95;
              const y1 = 130 + Math.sin(ang)*95;
              const x2 = 130 + Math.cos(ang)*105;
              const y2 = 130 + Math.sin(ang)*105;
              return `<line class="tick" x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}"></line>`;
            }).join('')}

            ${[12,1,2,3,4,5,6,7,8,9,10,11].map((n,idx)=>{
              const ang = (Math.PI*2)*(idx/12) - Math.PI/2;
              const x = 130 + Math.cos(ang)*75;
              const y = 130 + Math.sin(ang)*75 + 6;
              return `<text class="t" x="${x}" y="${y}" text-anchor="middle">${toArDigits(n)}</text>`;
            }).join('')}

            <line class="min" x1="130" y1="130" x2="50" y2="130"></line>
            <line class="hr" x1="130" y1="130" x2="185" y2="95"></line>
            <circle cx="130" cy="130" r="8" fill="#0f172a"></circle>
          </svg>
        </div>
      `;
    }

    function mediaQ14(){
      const data = [
        {score:4, count:5},
        {score:6, count:3},
        {score:8, count:6},
        {score:10, count:4},
      ];
      const max = Math.max(...data.map(d=>d.count));
      return `
        <div class="media" aria-label="مخطط أعمدة">
          <div style="display:flex;align-items:flex-end;gap:18px;justify-content:center;height:180px;padding:12px 10px 6px">
            ${data.map(d=>`
              <div style="width:70px;display:flex;flex-direction:column;align-items:center;gap:8px">
                <div style="
                  width:100%;
                  height:${(d.count/max)*140}px;
                  border-radius:14px;
                  border:1px solid rgba(124,58,237,.35);
                  background: linear-gradient(180deg, rgba(14,165,164,.20), rgba(124,58,237,.12));
                " title="عدد الطلاب: ${toArDigits(d.count)}"></div>
                <div style="font-weight:900">${toArDigits(d.score)}</div>
              </div>
            `).join('')}
          </div>
          <p class="help" style="margin:0;text-align:center">درجات الطلاب (٤، ٦، ٨، ١٠) — اختر الدرجة الأكثر تكرارًا.</p>
        </div>
      `;
    }

    const mediaById = { 5: mediaQ5, 8: mediaQ8, 9: mediaQ9, 10: mediaQ10, 12: mediaQ12, 14: mediaQ14 };

    const questions = [
      {
        id: 1,
        skill: "القيمة المكانية وتحويل الصيغة التحليلية إلى القياسية",
        text: "يكتب العدد ٣ + ٣٠ + ٣٠٠ + ٧٠٠٠ + ٣٠٠٠٠ بالصيغة القياسية التالية:",
        choices: [
          {key:"أ", text:"٣٣٣٧٣"},
          {key:"ب", text:"٧٣٣٣٣"},
          {key:"ج", text:"٣٧٣٣٣"},
          {key:"د", text:"٣٧٣٠٠"},
        ],
        answer:"ج",
        steps:[
          "رتّب القيم بحسب المنازل: ٣٠٠٠٠ + ٧٠٠٠ + ٣٠٠ + ٣٠ + ٣.",
          "اجمع: ٣٠٠٠٠ + ٧٠٠٠ = ٣٧٠٠٠.",
          "أضف ٣٠٠ ⇒ ٣٧٣٠٠، ثم ٣٠ ⇒ ٣٧٣٣٠، ثم ٣ ⇒ ٣٧٣٣٣."
        ],
        fbCorrect:"أحسنت! جمعت القيم المكانية وكتبت العدد بالصيغة القياسية بشكل صحيح.",
        fbWrong:"راجع ترتيب المنازل: عشرات الألوف ثم الألوف ثم المئات ثم العشرات ثم الآحاد."
      },
      {
        id: 2,
        skill: "مقارنة الكسور (المقامات المتساوية)",
        text: "أي الكسور التالية أكبر من ٣/٥ ؟",
        choices: [
          {key:"أ", text:"٤/٥"},
          {key:"ب", text:"٣/٥"},
          {key:"ج", text:"٢/٥"},
          {key:"د", text:"١/٥"},
        ],
        answer:"أ",
        steps:[
          "جميع المقامات = ٥.",
          "عند تساوي المقام نقارن البسط.",
          "٤ أكبر من ٣ ⇒ ٤/٥ أكبر من ٣/٥."
        ],
        fbCorrect:"ممتاز! عندما تتساوى المقامات نقارن البسط مباشرة.",
        fbWrong:"إذا كان المقام نفسه ركّز على البسط الأكبر."
      },
      {
        id: 3,
        skill: "حقائق القسمة (القسمة على ٣)",
        text: "١٥ ÷ ٣ =",
        choices: [
          {key:"أ", text:"١٥"},
          {key:"ب", text:"٥"},
          {key:"ج", text:"٤"},
          {key:"د", text:"٣"},
        ],
        answer:"ب",
        steps:[
          "ابحث عن عدد إذا ضربته في ٣ يعطي ١٥.",
          "٣ × ٥ = ١٥.",
          "إذن ١٥ ÷ ٣ = ٥."
        ],
        fbCorrect:"صحيح! استخدمت علاقة الضرب والقسمة.",
        fbWrong:"القسمة عكس الضرب: ابحث عن عدد × ٣ = ١٥."
      },
      {
        id: 4,
        skill: "التقدير بالتقريب لإيجاد الفرق",
        text: "إذا زار المتحف ٤٢٣ زائرًا يوم الأحد و٥٧٢ زائرًا يوم الخميس، ما التقدير المعقول للفرق بين العددين؟",
        choices: [
          {key:"أ", text:"٧٠٠"},
          {key:"ب", text:"٦٠٠"},
          {key:"ج", text:"٣٠٠"},
          {key:"د", text:"٢٠٠"},
        ],
        answer:"د",
        steps:[
          "قرّب ٥٧٢ ≈ ٦٠٠.",
          "قرّب ٤٢٣ ≈ ٤٠٠.",
          "الفرق ≈ ٦٠٠ − ٤٠٠ = ٢٠٠."
        ],
        fbCorrect:"رائع! تقدير الفرق بالتقريب أعطى نتيجة معقولة.",
        fbWrong:"قرّب لأقرب مئة ثم اطرح."
      },
      {
        id: 5,
        skill: "اكتشاف النمط العددي (الفروق المتتابعة)",
        text: "تتناقص مساحة المثلثات الموضحة من اليمين إلى اليسار. أوسع النمط لإيجاد ارتفاع المثلث التالي.",
        choices: [
          {key:"أ", text:"٤ سم"},
          {key:"ب", text:"٣ سم"},
          {key:"ج", text:"٢ سم"},
          {key:"د", text:"١ سم"},
        ],
        answer:"ب",
        steps:[
          "اقرأ الارتفاعات: ١٧، ١٢، ٨، ٥.",
          "احسب الفروق: −٥، −٤، −٣.",
          "الفروق تكمل: −٢.",
          "إذن الارتفاع التالي: ٥ − ٢ = ٣ سم."
        ],
        fbCorrect:"ممتاز! اكتشفت نمط الفروق (−٥، −٤، −٣، −٢).",
        fbWrong:"احسب الفروق بين الارتفاعات ثم أكمل النمط."
      },
      {
        id: 6,
        skill: "خاصية العنصر المحايد في الضرب",
        text: "العدد الذي إذا ضربته في ٩٢٥ كان الناتج ٩٢٥ هو:",
        choices: [
          {key:"أ", text:"٠"},
          {key:"ب", text:"١"},
          {key:"ج", text:"٢"},
          {key:"د", text:"١٠"},
        ],
        answer:"ب",
        steps:[
          "أي عدد × ١ = العدد نفسه.",
          "٩٢٥ × ١ = ٩٢٥."
        ],
        fbCorrect:"صحيح! العدد ١ هو العنصر المحايد في الضرب.",
        fbWrong:"٠ يجعل الناتج صفرًا، والعدد المحايد هو ١."
      },
      {
        id: 7,
        skill: "حل مسألة لفظية (جمع ثم طرح)",
        text: "مع كل من جمال وفوزي وسلمان ٤ طوابع. إذا أضاع جمال طابعًا واحدًا، فكم يصبح عدد الطوابع مع الأصدقاء الثلاثة معًا؟",
        choices: [
          {key:"أ", text:"٤"},
          {key:"ب", text:"١١"},
          {key:"ج", text:"١٢"},
          {key:"د", text:"١٣"},
        ],
        answer:"ب",
        steps:[
          "المجموع قبل الفقد: ٤+٤+٤ = ١٢.",
          "بعد فقد طابع: ١٢ − ١ = ١١."
        ],
        fbCorrect:"أحسنت! جمعت أولًا ثم طرحت الطابع المفقود.",
        fbWrong:"ابدأ بالمجموع ثم اطرح ١."
      },
      {
        id: 8,
        skill: "تمييز الأشكال المستوية والمجسمة",
        text: "الشكل الذي يختلف عن الأشكال الثلاثة الأخرى هو:",
        choices: [
          {key:"أ", text:"المكعب"},
          {key:"ب", text:"الأسطوانة"},
          {key:"ج", text:"المخروط"},
          {key:"د", text:"شكل مستوٍ (٢D)"},
        ],
        answer:"د",
        steps:[
          "المكعب والأسطوانة والمخروط مجسّمات (٣D).",
          "الشكل المستوي (٢D) مسطح.",
          "إذن المختلف هو (٢D)."
        ],
        fbCorrect:"صحيح! اخترت الشكل الوحيد المستوي.",
        fbWrong:"حدد: أيها ٣D وأيها ٢D؟"
      },
      {
        id: 9,
        skill: "قياس المساحة بعدّ الوحدات المربعة",
        text: "مساحة الشكل المجاور هي:",
        choices: [
          {key:"أ", text:"٣ وحدات مربعة"},
          {key:"ب", text:"٤ وحدات مربعة"},
          {key:"ج", text:"٥ وحدات مربعة"},
          {key:"د", text:"٦ وحدات مربعة"},
        ],
        answer:"د",
        steps:[
          "عدّ المربعات.",
          "٢ صف × ٣ أعمدة = ٦.",
          "المساحة = ٦ وحدات مربعة."
        ],
        fbCorrect:"ممتاز! المساحة ٦ وحدات مربعة.",
        fbWrong:"عدّ المربعات: ٢×٣."
      },
      {
        id: 10,
        skill: "تقدير الطول باستخدام السنتيمتر",
        text: "في حال تم شدّ الخيط الموجود في الرسم ليكون مستقيمًا، فإن التقدير الأقرب لطوله هو:",
        choices: [
          {key:"أ", text:"٥ سم"},
          {key:"ب", text:"٧ سم"},
          {key:"ج", text:"٨ سم"},
          {key:"د", text:"٩ سم"},
        ],
        answer:"ب",
        steps:[
          "تخيّل الخيط بعد شده.",
          "قارنه بتدريج المسطرة.",
          "الأقرب ≈ ٧ سم."
        ],
        fbCorrect:"رائع! الأقرب بعد الشد هو ٧ سم.",
        fbWrong:"اختر الأقرب بناءً على المقارنة مع المسطرة."
      },
      {
        id: 11,
        skill: "النقود: إيجاد المبلغ الناقص (طرح)",
        text: "إذا أراد إبراهيم أن يشتري هدية ثمنها ٧٥٠ ريالًا، وليس معه سوى ورقة ٥٠٠ ريال وورقتين من فئة ٥٠ ريالًا، فكم ريالًا إضافيًا يحتاج؟",
        choices: [
          {key:"أ", text:"٥٠ ريال"},
          {key:"ب", text:"١٠٠ ريال"},
          {key:"ج", text:"١٥٠ ريال"},
          {key:"د", text:"٢٠٠ ريال"},
        ],
        answer:"ج",
        steps:[
          "المبلغ معه: ٥٠٠+٥٠+٥٠ = ٦٠٠.",
          "الناقص: ٧٥٠−٦٠٠ = ١٥٠."
        ],
        fbCorrect:"ممتاز! حسبت الناقص بشكل صحيح.",
        fbWrong:"اجمع ما معه ثم اطرح من ٧٥٠."
      },
      {
        id: 12,
        skill: "قراءة الساعة التناظرية (الدقائق والخمسات)",
        text: "الزمن الذي تشير إليه الساعة هو:",
        choices: [
          {key:"أ", text:"١:٤٥"},
          {key:"ب", text:"٢:٤٥"},
          {key:"ج", text:"١:٠٩"},
          {key:"د", text:"٢:٠٩"},
        ],
        answer:"أ",
        steps:[
          "عقرب الدقائق على ٩ ⇒ ٤٥ دقيقة.",
          "عقرب الساعات بين ١ و٢ ⇒ الساعة ١.",
          "إذن ١:٤٥."
        ],
        fbCorrect:"أحسنت! القراءة ١:٤٥.",
        fbWrong:"ابدأ بعقرب الدقائق ثم عقرب الساعات."
      },
      {
        id: 13,
        skill: "الطرح ضمن الألف",
        text: "لدى محمد ٩٠٠ ريال، تصدّق بمبلغ ٩٠ ريالًا، كم بقي لدى محمد؟",
        choices: [
          {key:"أ", text:"٨٩٠"},
          {key:"ب", text:"٨١٠"},
          {key:"ج", text:"١٩٠"},
          {key:"د", text:"١١٠"},
        ],
        answer:"ب",
        steps:[
          "اطرح: ٩٠٠−٩٠.",
          "الناتج: ٨١٠."
        ],
        fbCorrect:"صحيح! ٩٠٠−٩٠ = ٨١٠.",
        fbWrong:"انتبه: طرح ٩٠ من ٩٠٠ يعطي ٨١٠."
      },
      {
        id: 14,
        skill: "قراءة التمثيل البياني بالأعمدة (الأكثر تكرارًا)",
        text: "يبين الشكل عدد الطلاب الذين حصلوا على درجات (٤، ٦، ٨، ١٠). ما الدرجة التي حصل عليها أكثر الطلاب؟",
        choices: [
          {key:"أ", text:"٤"},
          {key:"ب", text:"٦"},
          {key:"ج", text:"٨"},
          {key:"د", text:"١٠"},
        ],
        answer:"ج",
        steps:[
          "ابحث عن أطول عمود.",
          "أطول عمود عند الدرجة ٨.",
          "إذن الأكثر هو ٨."
        ],
        fbCorrect:"ممتاز! الأعلى يعني الأكثر.",
        fbWrong:"الأكثر = العمود الأعلى."
      },
      {
        id: 15,
        skill: "فهم الضرب كجمع متكرر",
        text: "في أي الحالات الآتية يكون ناتج الضرب ٩؟",
        choices: [
          {key:"أ", text:"٤ قطط لكل منها أنف واحد"},
          {key:"ب", text:"٦ أفيال لكل منها أذنان"},
          {key:"ج", text:"٤ خراف لكل منها عينان"},
          {key:"د", text:"٣ سمكات لكل منها ٣ زعانف"},
        ],
        answer:"د",
        steps:[
          "حوّل كل خيار إلى ضرب (مجموعات × عناصر).",
          "أ: ٤×١=٤، ب: ٦×٢=١٢، ج: ٤×٢=٨، د: ٣×٣=٩.",
          "إذن الصحيح هو (د)."
        ],
        fbCorrect:"رائع! ٣×٣ = ٩.",
        fbWrong:"اكتب ضرب كل خيار ثم اختر الناتج ٩."
      },
    ];

    const state = {
      started:false,
      mode:"test",
      name:"",
      minutes:0,
      qIndex:0,
      answers:{},
      timerId:null,
      remainingSec:0,
      startTs:0,
      submitted:false
    };

    const app = document.getElementById("app");
    const statusPills = document.getElementById("statusPills");
    const pillName = document.getElementById("pillName");
    const pillProg = document.getElementById("pillProg");
    const pillTimerWrap = document.getElementById("pillTimerWrap");
    const pillTimer = document.getElementById("pillTimer");

    function setPills(){
      statusPills.style.display = state.started ? "" : "none";
      pillName.textContent = state.name ? state.name : "—";
      pillProg.textContent = `${toArDigits(state.qIndex+1)}/${toArDigits(questions.length)}`;
      if(state.minutes>0){
        pillTimerWrap.style.display = "";
        pillTimer.textContent = formatTime(state.remainingSec);
      }else{
        pillTimerWrap.style.display = "none";
      }
    }

    function formatTime(sec){
      sec = Math.max(0, Math.floor(sec));
      const m = Math.floor(sec/60);
      const s = sec%60;
      return `${toArDigits(m)}:${toArDigits(String(s).padStart(2,"0"))}`;
    }

    function renderStart(){
      state.started = false;
      state.submitted = false;
      clearTimer();

      app.innerHTML = `
        <div class="cardHead">
          <div class="title">
            <h1>ابدأ الاختبار</h1>
            <p>اختر الإعدادات ثم اضغط “ابدأ”.</p>
          </div>
          <div class="pillRow">
            <button class="btn secondary" id="btnPrintStart">طباعة</button>
          </div>
        </div>

        <div class="content grid2">
          <div class="panel">
            <h2>بيانات الطالب</h2>
            <div class="field">
              <label for="studentName">اسم الطالب (اختياري)</label>
              <input id="studentName" type="text" placeholder="اكتب الاسم هنا" maxlength="40" />
            </div>

            <h2 style="margin-top:14px">وضع التشغيل</h2>
            <div class="row">
              <div class="toggle">
                <input type="radio" name="mode" id="modeTest" value="test" checked />
                <label for="modeTest" style="margin:0;color:var(--ink);font-weight:900">وضع اختبار (التصحيح في النهاية)</label>
              </div>
              <div class="toggle">
                <input type="radio" name="mode" id="modeTrain" value="train" />
                <label for="modeTrain" style="margin:0;color:var(--ink);font-weight:900">وضع تدريب (تغذية راجعة مباشرة + شرح)</label>
              </div>
            </div>

            <h2 style="margin-top:14px">مؤقّت (اختياري)</h2>
            <div class="row">
              <div class="field" style="margin:0;min-width:220px">
                <label for="minutes">المدة بالدقائق (٠ = بدون)</label>
                <input id="minutes" type="number" min="0" max="120" value="0" />
              </div>
              <p class="help" style="margin:0">إذا انتهى الوقت سيتم تسليم الاختبار تلقائيًا.</p>
            </div>

            <div class="row" style="margin-top:12px">
              <button class="btn" id="btnStart">ابدأ</button>
              <button class="btn ghost" id="btnPreview">معاينة الأسئلة</button>
            </div>

            <div class="progress"><div class="bar" style="width:0%"></div></div>
          </div>

          <div class="panel">
            <h2>تنبيه الصور</h2>
            <p class="help">• ضع صورة سؤال ٥ باسم <b>q5.png</b> بجانب ملف الاختبار (أو q5_new.png).</p>
            <p class="help">• ضع صورة سؤال ١٠ باسم <b>q10.png</b> بجانب ملف الاختبار (أو q10_new.png).</p>
            <p class="help">• إذا كانت الصور داخل <b>assets</b> أو <b>images</b> فالكود سيجربها تلقائيًا.</p>
          </div>
        </div>
      `;

      document.getElementById("btnStart").onclick = () => {
        const name = document.getElementById("studentName").value.trim();
        const mode = document.querySelector('input[name="mode"]:checked')?.value || "test";
        const minutes = clamp(parseInt(document.getElementById("minutes").value || "0",10), 0, 120);
        startQuiz({name, mode, minutes});
      };

      document.getElementById("btnPreview").onclick = () => renderPreview();
      document.getElementById("btnPrintStart").onclick = () => window.print();
      setPills();
    }

    function renderPreview(){
      app.innerHTML = `
        <div class="cardHead">
          <div class="title">
            <h1>معاينة الأسئلة</h1>
            <p>عرض سريع قبل البدء (المهارة المستهدفة لكل سؤال).</p>
          </div>
          <div class="pillRow">
            <button class="btn secondary" id="backStart">رجوع</button>
          </div>
        </div>
        <div class="content">
          ${questions.map(q=>`
            <div class="panel" style="margin-bottom:12px">
              <div class="qHead">
                <div class="qNum">سؤال ${toArDigits(q.id)}</div>
                <span class="chip skill">المهارة: ${q.skill}</span>
              </div>
              <p class="qText">${q.text}</p>
              ${mediaById[q.id] ? mediaById[q.id]() : ""}
              <div class="choices" style="pointer-events:none;opacity:.95">
                ${q.choices.map(c=>`
                  <div class="choice">
                    <div class="key">${c.key}</div>
                    <div class="txt">${c.text}</div>
                  </div>
                `).join("")}
              </div>
            </div>
          `).join("")}
        </div>
      `;
      document.getElementById("backStart").onclick = renderStart;
      initFallbackImages(app);
      setPills();
    }

    function startQuiz({name, mode, minutes}){
      state.started = true;
      state.submitted = false;
      state.name = name || "";
      state.mode = mode;
      state.minutes = minutes;
      state.qIndex = 0;
      state.answers = {};
      state.startTs = Date.now();

      if(minutes > 0){
        state.remainingSec = minutes * 60;
        startTimer();
      }else{
        state.remainingSec = 0;
      }
      renderQuestion();
      setPills();
    }

    function renderQuestion(){
      const q = questions[state.qIndex];
      const selected = state.answers[q.id] || null;
      const progress = ((state.qIndex+1)/questions.length)*100;

      app.innerHTML = `
        <div class="cardHead">
          <div class="title">
            <h1>سؤال ${toArDigits(q.id)} من ${toArDigits(questions.length)}</h1>
            <p>${state.mode === "train" ? "وضع تدريب: تظهر التغذية الراجعة والشرح بعد الاختيار." : "وضع اختبار: تظهر المراجعة بعد التسليم."}</p>
          </div>
          <div class="pillRow">
            <button class="btn secondary" id="btnExit">إنهاء</button>
            <button class="btn ghost" id="btnPrint">طباعة</button>
          </div>
        </div>

        <div class="content">
          <div class="qHead">
            <span class="qNum">سؤال ${toArDigits(q.id)}</span>
            <span class="mini">التقدّم: ${toArDigits(state.qIndex+1)}/${toArDigits(questions.length)}</span>
          </div>

          <div class="subRow">
            <span class="chip skill">المهارة المستهدفة: ${q.skill}</span>
          </div>

          <p class="qText">${q.text}</p>
          ${mediaById[q.id] ? mediaById[q.id]() : ""}

          <div class="choices" id="choices">
            ${q.choices.map(c=>{
              const isSel = selected === c.key;
              return `
                <div class="choice ${isSel ? "selected":""}" data-key="${c.key}" role="button" tabindex="0">
                  <div class="key">${c.key}</div>
                  <div class="txt">${c.text}</div>
                </div>
              `;
            }).join("")}
          </div>

          <div class="feedback" id="feedback">
            <h3 id="fbTitle"></h3>
            <p id="fbText"></p>
            <div class="note" id="fbSkill"></div>
            <div class="note" id="fbExplain"></div>
            <ul id="fbSteps"></ul>
          </div>

          <div class="progress"><div class="bar" style="width:${progress}%"></div></div>

          <div class="nav">
            <div class="left">
              <button class="btn secondary" id="btnPrev" ${state.qIndex===0 ? "disabled":""}>السابق</button>
              <button class="btn secondary" id="btnNext">${state.qIndex===questions.length-1 ? "مراجعة وتسليم" : "التالي"}</button>
            </div>
            <div class="right"><span class="mini">يمكنك تغيير الإجابة قبل التسليم.</span></div>
          </div>
        </div>
      `;

      document.getElementById("btnExit").onclick = () => renderStart();
      document.getElementById("btnPrint").onclick = () => window.print();

      document.getElementById("btnPrev").onclick = () => {
        if(state.qIndex>0){ state.qIndex--; renderQuestion(); setPills(); }
      };
      document.getElementById("btnNext").onclick = () => {
        if(state.qIndex < questions.length-1){
          state.qIndex++; renderQuestion(); setPills();
        }else{
          submitQuiz();
        }
      };

      const choicesEl = document.getElementById("choices");
      choicesEl.querySelectorAll(".choice").forEach(el=>{
        el.onclick = () => selectChoice(q, el.getAttribute("data-key"));
        el.onkeydown = (e) => {
          if(e.key==="Enter" || e.key===" "){
            e.preventDefault();
            selectChoice(q, el.getAttribute("data-key"));
          }
        };
      });

      initFallbackImages(app);

      if(state.mode==="train" && selected){
        showFeedback(q, selected);
      }
      setPills();
    }

    function selectChoice(q, key){
      state.answers[q.id] = key;

      const choicesEl = document.getElementById("choices");
      choicesEl.querySelectorAll(".choice").forEach(el=>{
        el.classList.toggle("selected", el.getAttribute("data-key")===key);
        el.classList.remove("correct","wrong");
      });

      if(state.mode==="train"){
        showFeedback(q, key);
      }
    }

    function showFeedback(q, chosen){
      const fb = document.getElementById("feedback");
      const title = document.getElementById("fbTitle");
      const text = document.getElementById("fbText");
      const fbSkill = document.getElementById("fbSkill");
      const fbExplain = document.getElementById("fbExplain");
      const fbSteps = document.getElementById("fbSteps");

      const isCorrect = chosen === q.answer;

      fb.style.display = "block";
      fb.classList.toggle("good", isCorrect);
      fb.classList.toggle("bad", !isCorrect);

      title.textContent = isCorrect ? "إجابة صحيحة ✅" : "إجابة غير صحيحة ❌";
      text.textContent = isCorrect ? q.fbCorrect : `الإجابة الصحيحة هي (${q.answer}). ${q.fbWrong}`;
      fbSkill.innerHTML = `<b>المهارة المستهدفة:</b> ${q.skill}`;
      fbExplain.innerHTML = `<b>الشرح المختصر:</b> اتّبع الخطوات التالية:`;
      fbSteps.innerHTML = (q.steps || []).map(s => `<li>${s}</li>`).join("");

      const choicesEl = document.getElementById("choices");
      choicesEl.querySelectorAll(".choice").forEach(el=>{
        const k = el.getAttribute("data-key");
        if(k === q.answer) el.classList.add("correct");
        if(k === chosen && chosen !== q.answer) el.classList.add("wrong");
      });
    }

    function submitQuiz(){
      state.submitted = true;
      clearTimer();

      const total = questions.length;
      let correct = 0;

      const details = questions.map(q=>{
        const chosen = state.answers[q.id] || null;
        const ok = chosen === q.answer;
        if(ok) correct++;
        const chosenObj = q.choices.find(c=>c.key===chosen);
        const ansObj = q.choices.find(c=>c.key===q.answer);
        return {
          id:q.id,
          skill:q.skill,
          text:q.text,
          chosen,
          chosenText: chosenObj ? chosenObj.text : null,
          answer:q.answer,
          answerText: ansObj ? ansObj.text : null,
          ok,
          steps:q.steps,
          fbCorrect:q.fbCorrect,
          fbWrong:q.fbWrong
        };
      });

      const percent = Math.round((correct/total)*100);
      const spentSec = Math.max(0, Math.floor((Date.now()-state.startTs)/1000));
      const wrongSkills = uniq(details.filter(d=>!d.ok).map(d=>d.skill));

      app.innerHTML = `
        <div class="cardHead">
          <div class="title">
            <h1>نتيجة الاختبار</h1>
            <p>${state.name ? `الطالب: <b>${state.name}</b> — ` : ""}تم التسليم بنجاح.</p>
          </div>
          <div class="pillRow">
            <button class="btn secondary" id="btnRestart">إعادة المحاولة</button>
            <button class="btn ghost" id="btnPrintRes">طباعة</button>
          </div>
        </div>

        <div class="content">
          <div class="resultBox">
            <div class="stat"><b>${toArDigits(correct)} / ${toArDigits(total)}</b><p>عدد الإجابات الصحيحة</p></div>
            <div class="stat"><b>${toArDigits(percent)}%</b><p>النسبة المئوية</p></div>
            <div class="stat"><b>${toArDigits(spentSec)} ثانية</b><p>الوقت المستغرق</p></div>
            <div class="stat"><b>${state.mode==="train" ? "تدريب" : "اختبار"}</b><p>وضع التشغيل</p></div>
          </div>

          <div class="skillsNeed" style="${wrongSkills.length? "":"display:none"}">
            <h3>مهارات تحتاج تعزيز</h3>
            <div class="chips">
              ${wrongSkills.map(s=>`<span class="chip skill">${s}</span>`).join("")}
            </div>
          </div>

          <div class="review" style="margin-top:14px">
            <div class="rHead">مراجعة الإجابات (مهارة + شرح)</div>
            ${details.map(d=>{
              const chosenKey = d.chosen ? `(${d.chosen})` : "—";
              const chosenLine = d.chosen ? `${chosenKey} ${d.chosenText}` : "—";
              const ansLine = `(${d.answer}) ${d.answerText}`;
              const feedLine = d.ok ? d.fbCorrect : `الإجابة الصحيحة هي ${ansLine}. ${d.fbWrong}`;
              return `
                <div class="rItem">
                  <p class="rQ">سؤال ${toArDigits(d.id)}
                    <span class="tag ${d.ok ? "good":"bad"}">${d.ok ? "صحيح" : "خطأ"}</span>
                  </p>
                  <p class="rMeta"><b>المهارة:</b> ${d.skill}</p>
                  <p class="rMeta"><b>إجابتك:</b> ${chosenLine}</p>
                  <p class="rMeta"><b>الإجابة الصحيحة:</b> ${ansLine}</p>
                  <p class="rMeta"><b>التغذية الراجعة:</b> ${feedLine}</p>
                  <p class="rMeta" style="margin-top:8px"><b>خطوات الحل:</b></p>
                  <ul class="rSteps">${(d.steps||[]).map(s=>`<li>${s}</li>`).join("")}</ul>
                </div>
              `;
            }).join("")}
          </div>
        </div>
      `;

      document.getElementById("btnRestart").onclick = () => renderStart();
      document.getElementById("btnPrintRes").onclick = () => window.print();
      setPills();
    }

    function startTimer(){
      clearTimer();
      setPills();
      state.timerId = setInterval(()=>{
        state.remainingSec--;
        setPills();
        if(state.remainingSec <= 0){
          clearTimer();
          submitQuiz();
        }
      }, 1000);
    }
    function clearTimer(){
      if(state.timerId){
        clearInterval(state.timerId);
        state.timerId = null;
      }
    }

    renderStart();
  </script>
</body>
</html>
